# 头皮分析系统使用指南
# Scalp Analysis System Usage Guide

## 🎯 问题诊断结果

### 根本原因

测试发现你的系统**已经正常工作**！问题是：

1. **测试使用了纯色图片**
   - `test_ai_direct.py` 创建的是纯色背景测试图
   - Claude AI 正确识别出这不是头皮照片
   - 返回了拒绝分析的文本说明

2. **需要真实的头皮照片**
   - AI 需要看到**真实的头发和头皮细节**
   - 纯色图、风景图等都无法分析

---

## ✅ 系统已完成的改进

### 1. **双 AI 引擎支持**
- ✅ **GPT-4o** - OpenAI 最新多模态模型
- ✅ **Claude 3 Haiku** - Anthropic 医学专家模型
- ✅ 智能模型回退（自动尝试多个模型）

### 2. **增强的错误处理**
- ✅ 详细的错误提示
- ✅ 针对性的解决建议
- ✅ 完整的错误堆栈显示

### 3. **调试模式**
- ✅ 可视化的调试信息
- ✅ 显示 AI 原始响应
- ✅ 配置状态检查

### 4. **改进的 Prompt**
- ✅ 强制要求 JSON 格式输出
- ✅ 更详细的医学分析要求
- ✅ 处理无效图片的情况

---

## 🚀 如何正确使用

### 步骤 1：启动应用

```bash
streamlit run app.py
```

或使用备用端口：
```bash
streamlit run app.py --server.port 8502
```

访问：http://localhost:8501 或 http://localhost:8502

### 步骤 2：准备头皮照片

**✅ 好的照片：**
- 近距离拍摄头皮
- 能看到头发和头皮细节
- 光线充足、清晰
- 焦点在头皮上

**❌ 不好的照片：**
- 纯色图片
- 模糊不清
- 距离太远
- 光线不足
- 没有头发或头皮

### 步骤 3：配置 AI 服务

#### 选项 A：使用 GPT-4（OpenAI）

1. 获取 API 密钥：https://platform.openai.com/api-keys
2. 确保账户有余额
3. 在应用中：
   - 勾选 "使用AI增强分析"
   - 选择 "GPT-4 (OpenAI)"
   - 输入 API 密钥
   - 点击 "开始AI分析"

**可用模型（自动尝试）：**
- gpt-4o-mini ⭐ 推荐（大多数账户可用）
- gpt-4o
- gpt-4-turbo
- gpt-4-vision-preview

#### 选项 B：使用 Claude（Anthropic）

1. 获取 API 密钥：https://console.anthropic.com/
2. 在应用中：
   - 勾选 "使用AI增强分析"
   - 选择 "Claude (Anthropic)"
   - 输入 API 密钥
   - 点击 "开始AI分析"

**使用模型：**
- claude-3-haiku-20240307

### 步骤 4：分析结果

成功分析后，你会看到：

- **头皮类型**：油性/干性/正常/混合/敏感
- **健康评分**：0-100 分（严格评分）
- **医学诊断**：
  - 疾病名称（中英文）
  - 严重程度（轻度/中度/重度）
  - 置信度（0-100%）
  - 症状描述
- **护理建议**：具体的治疗或护理建议
- **是否需要就医**：专业判断

---

## 🐛 调试模式

如果分析结果不理想，启用调试模式：

1. 上传照片后
2. 勾选 **"🐛 启用调试模式 (Debug Mode)"**
3. 点击分析
4. 查看 **"🐛 调试: AI 原始返回结果"** 展开器

这会显示：
- AI 调用的详细过程
- 完整的 JSON 响应
- 所有字段的值

---

## ⚠️ 常见问题

### Q1: "Error code: 404 - The model does not exist"

**原因：** 你的 OpenAI 账户没有访问该模型的权限

**解决：**
1. 确认账户已升级到付费版
2. 检查账户余额
3. 系统会自动尝试其他模型（如 gpt-4o-mini）

### Q2: "头皮类型显示为 Unknown"

**原因：**
- 图片不是头皮照片
- 图片质量不足
- AI 无法识别

**解决：**
1. 上传真实的头皮照片
2. 确保照片清晰、光线充足
3. 启用调试模式查看原因

### Q3: "API密钥问题"

**原因：** API 密钥无效或未授权

**解决：**
1. 检查密钥是否正确复制（无多余空格）
2. 确认密钥未被撤销
3. 重新生成新的 API 密钥

### Q4: "所有模型都无法访问"

**原因：** 账户没有访问任何 GPT-4 模型的权限

**解决：**
1. 充值账户
2. 升级到付费版
3. 尝试使用 Claude

---

## 📊 模型对比

| 特性 | GPT-4o | Claude 3 Haiku |
|------|--------|----------------|
| **视觉分析** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **医学专业性** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **分析速度** | 5-15秒 | 3-8秒 |
| **成本** | 较高 | 较低 |
| **推荐场景** | 视觉细节分析 | 医学诊断 |

---

## 🔧 测试工具

### 1. 检查可用模型

```bash
python check_available_models.py
```

输入 API 密钥后，显示你的账户可以访问哪些模型。

### 2. 直接测试 AI 服务

```bash
python test_ai_direct.py
```

选择 GPT-4 或 Claude，输入 API 密钥，直接测试分析功能。

⚠️ **注意：** 这些测试脚本使用纯色测试图，AI 会拒绝分析。这是**正常行为**。

### 3. OpenAI 密钥快速测试

```bash
python test_openai_key.py
```

快速验证 OpenAI API 密钥是否有效。

---

## 💡 最佳实践

### 拍摄头皮照片的技巧

1. **光线**：自然光最好，避免直射强光
2. **距离**：10-20cm 近距离拍摄
3. **角度**：垂直或 45° 角度
4. **焦点**：对焦在头皮上，确保清晰
5. **区域**：包含头发和头皮的接触区域

### 选择 AI 服务

- **优先推荐**：GPT-4o-mini（成本低、大多数账户可用）
- **最佳效果**：GPT-4o（视觉分析最强）
- **医学专业**：Claude（医学术语准确）
- **成本控制**：Claude（最经济）

### 提高分析准确性

1. 使用高质量照片
2. 上传多个角度的照片
3. 对比两个 AI 的结果
4. 启用调试模式查看详情
5. 根据建议改善拍摄质量

---

## 📞 获取帮助

### 问题排查顺序

1. ✅ 检查是否使用真实头皮照片
2. ✅ 启用调试模式查看详情
3. ✅ 运行测试工具验证 API
4. ✅ 查看错误提示和建议
5. ✅ 尝试切换 AI 服务

### 联系支持

- Email: support@scalpanalyzer.my
- 文档：查看 `GPT4_SETUP_GUIDE.md`
- GitHub Issues：[项目地址]

---

## 🎉 总结

你的系统现在已经：

✅ 支持 GPT-4 和 Claude 双引擎
✅ 智能模型回退机制
✅ 详细的错误处理和提示
✅ 调试模式
✅ 强制 JSON 格式输出

**关键要点：**
- 使用**真实的头皮照片**，不是测试图
- 确保 API 密钥有效且有余额
- 启用调试模式查看详细信息
- 对比不同 AI 的分析结果

**现在上传一张真实的头皮照片试试吧！** 🚀
